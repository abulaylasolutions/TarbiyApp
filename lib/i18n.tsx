import React, { createContext, useContext, useState, useMemo, ReactNode, useCallback } from 'react';
import { I18nManager, Platform } from 'react-native';

export type Language = 'it' | 'en' | 'ar';

const translations: Record<Language, Record<string, string>> = {
  it: {
    home: 'Home',
    dashboard: 'Dashboard',
    bacheca: 'Bacheca',
    settings: 'Impostazioni',
    hello: 'Ciao',
    parent: 'Genitore',
    yourChildren: 'I tuoi figli',
    limit: 'Limite',
    noChildrenTitle: 'Nessun figlio aggiunto',
    noChildrenSub: 'Tocca il pulsante + per aggiungere il tuo primo figlio',
    addChild: 'Aggiungi figlio',
    editChild: 'Modifica figlio',
    childName: 'Nome / Soprannome *',
    childNamePlaceholder: 'Nome del bambino',
    birthDate: 'Data di nascita *',
    gender: 'Sesso *',
    male: 'Maschio',
    female: 'Femmina',
    coParent: 'Cogenitore',
    connectCoParent: 'Collega prima un cogenitore nelle Impostazioni',
    cardColor: 'Colore card',
    cancel: 'Annulla',
    save: 'Salva',
    delete: 'Elimina',
    deleteConfirm: 'Vuoi eliminare',
    limitReachedTitle: 'Limite raggiunto',
    limitReachedMsg: 'Con il piano gratuito puoi aggiungere massimo 1 figlio. Passa a Premium per figli illimitati!',
    enterName: 'Inserisci il nome del bambino.',
    invalidDate: 'Inserisci una data di nascita valida.',
    selectGender: 'Seleziona il sesso del bambino.',
    sonOf: 'figlio tuo e di',
    daughterOf: 'figlia tua e di',
    years: 'anni',
    year: 'anno',
    months: 'mesi',
    photoOptional: 'Foto profilo (opzionale)',
    progress: 'Progressi',
    recentActivity: 'Attività Recenti',
    addChildFromHome: 'Aggiungi un figlio dalla Home',
    toViewDashboard: 'per visualizzare la dashboard',
    memorizedSurah: 'Ha memorizzato Surat Al-Fatiha',
    completedDua: 'Completata lezione sulle Du\'a',
    practicedAdab: 'Praticato Adab a tavola',
    example: 'Esempio',
    coParents: 'Cogenitori',
    yourInviteCode: 'Il tuo codice invito',
    copied: 'Copiato!',
    inviteCodeCopied: 'Codice invito copiato negli appunti',
    connectFirstCoParent: 'Collega il primo cogenitore',
    addAnotherCoParent: 'Aggiungi altro cogenitore',
    codeMustBe6: 'Il codice deve essere di 6 caratteri',
    connected: 'Collegato!',
    coParentConnected: 'Cogenitore collegato con successo!',
    code6chars: 'Codice 6 caratteri',
    removeConnection: 'Rimuovi collegamento',
    removeConnectionWith: 'Rimuovere il collegamento con',
    remove: 'Rimuovi',
    dad: 'Papa',
    mom: 'Mamma',
    coParentLabel: 'Cogenitore',
    pendingApprovals: 'Approvazioni in attesa',
    wantsToAdd: 'Vuole aggiungere',
    aChild: 'un figlio',
    general: 'Generale',
    account: 'Account',
    language: 'Lingua',
    plan: 'Piano',
    premium: 'Premium',
    free: 'Gratuito',
    info: 'Info',
    privacy: 'Privacy',
    privacyMsg: 'I tuoi dati sono sincronizzati in modo sicuro.',
    version: 'Versione',
    logout: 'Logout',
    logoutConfirm: 'Vuoi uscire dal tuo account?',
    upgradeTitle: 'Passa a Premium',
    upgradeSub: 'Figli illimitati + funzioni extra',
    editProfile: 'Modifica profilo',
    changPhoto: 'Cambia foto',
    yourName: 'Il tuo nome',
    name: 'Nome',
    invalidBirthDate: 'Data di nascita non valida.',
    selectYourGender: 'Seleziona il genere.',
    enterYourName: 'Inserisci il tuo nome.',
    islamicEducation: 'Educazione islamica per i tuoi figli',
    italian: 'Italiano',
    english: 'English',
    arabic: 'العربية',
    selectLanguage: 'Seleziona lingua',
    bacheca_title: 'Bacheca',
    writeNote: 'Scrivi una nota...',
    noteDetail: 'Dettaglio nota',
    comments: 'Commenti',
    writeComment: 'Scrivi un commento...',
    noComments: 'Nessun commento ancora',
    deleteNote: 'Elimina nota',
    deleteNoteConfirm: 'Vuoi eliminare questa nota?',
    tags: 'Tag',
    todayEvents: 'Eventi di oggi',
    noEventsToday: 'Nessun evento oggi',
    addWithPlus: 'Aggiungi con +',
    addEvent: 'Aggiungi evento',
    eventName: 'Nome evento',
    eventNamePlaceholder: 'Es. Scuola Arabo',
    frequency: 'Frequenza',
    daily: 'Giornaliero',
    weekly: 'Settimanale',
    monthly: 'Mensile',
    timePicker: 'Orario',
    today: 'Oggi',
    salahToday: 'Salah di oggi',
    fajr: 'Fajr',
    dhuhr: 'Dhuhr',
    asr: 'Asr',
    maghrib: 'Maghrib',
    isha: 'Isha',
    fastingToday: 'Digiuno oggi?',
    yes: 'Si',
    no: 'No',
    partial: 'Parziale',
    subjects: 'Educazione',
    arabo: 'Arabo',
    quran: "Qur'an",
    akhlaq: 'Akhlaq',
    aqidah: 'Aqidah',
    recentActivityLog: 'Attivita recenti',
    noActivity: 'Nessuna attivita registrata',
    done: 'Fatto',
    notDone: 'Non fatto',
    noteOptional: 'Nota breve...',
    childOf: 'di',
    startTime: 'Orario inizio',
    endTimePicker: 'Orario fine',
    selectDay: 'Seleziona giorno',
    selectDayOfMonth: 'Giorno del mese',
    sun: 'Dom',
    mon: 'Lun',
    tue: 'Mar',
    wed: 'Mer',
    thu: 'Gio',
    fri: 'Ven',
    sat: 'Sab',
    quranMemorization: 'Memorizzazione del Quran',
    surahLearned: 'Imparata',
    surahInProgress: 'In corso',
    surahNotStarted: 'Da imparare',
    surahCount: 'Sure imparate',
    quranToday: "Qur'an oggi?",
    salahTracker: 'Tracker Salah',
    fastingTracker: 'Tracker Digiuno',
    enabled: 'Attivo',
    disabled: 'Disattivo',
    deleteChild: 'Elimina figlio',
    childSettings: 'Impostazioni figlio',
  },
  en: {
    home: 'Home',
    dashboard: 'Dashboard',
    bacheca: 'Board',
    settings: 'Settings',
    hello: 'Hello',
    parent: 'Parent',
    yourChildren: 'Your children',
    limit: 'Limit',
    noChildrenTitle: 'No children added',
    noChildrenSub: 'Tap the + button to add your first child',
    addChild: 'Add child',
    editChild: 'Edit child',
    childName: 'Name / Nickname *',
    childNamePlaceholder: 'Child\'s name',
    birthDate: 'Date of birth *',
    gender: 'Gender *',
    male: 'Male',
    female: 'Female',
    coParent: 'Co-parent',
    connectCoParent: 'Connect a co-parent first in Settings',
    cardColor: 'Card color',
    cancel: 'Cancel',
    save: 'Save',
    delete: 'Delete',
    deleteConfirm: 'Do you want to delete',
    limitReachedTitle: 'Limit reached',
    limitReachedMsg: 'With the free plan you can add max 1 child. Upgrade to Premium for unlimited!',
    enterName: 'Enter the child\'s name.',
    invalidDate: 'Enter a valid date of birth.',
    selectGender: 'Select the child\'s gender.',
    sonOf: 'son of you and',
    daughterOf: 'daughter of you and',
    years: 'years',
    year: 'year',
    months: 'months',
    photoOptional: 'Profile photo (optional)',
    progress: 'Progress',
    recentActivity: 'Recent Activity',
    addChildFromHome: 'Add a child from Home',
    toViewDashboard: 'to view the dashboard',
    memorizedSurah: 'Memorized Surat Al-Fatiha',
    completedDua: 'Completed Du\'a lesson',
    practicedAdab: 'Practiced table manners (Adab)',
    example: 'Example',
    coParents: 'Co-parents',
    yourInviteCode: 'Your invite code',
    copied: 'Copied!',
    inviteCodeCopied: 'Invite code copied to clipboard',
    connectFirstCoParent: 'Connect the first co-parent',
    addAnotherCoParent: 'Add another co-parent',
    codeMustBe6: 'The code must be 6 characters',
    connected: 'Connected!',
    coParentConnected: 'Co-parent connected successfully!',
    code6chars: '6-char code',
    removeConnection: 'Remove connection',
    removeConnectionWith: 'Remove the connection with',
    remove: 'Remove',
    dad: 'Dad',
    mom: 'Mom',
    coParentLabel: 'Co-parent',
    pendingApprovals: 'Pending approvals',
    wantsToAdd: 'Wants to add',
    aChild: 'a child',
    general: 'General',
    account: 'Account',
    language: 'Language',
    plan: 'Plan',
    premium: 'Premium',
    free: 'Free',
    info: 'Info',
    privacy: 'Privacy',
    privacyMsg: 'Your data is securely synced.',
    version: 'Version',
    logout: 'Logout',
    logoutConfirm: 'Do you want to log out?',
    upgradeTitle: 'Upgrade to Premium',
    upgradeSub: 'Unlimited children + extra features',
    editProfile: 'Edit profile',
    changPhoto: 'Change photo',
    yourName: 'Your name',
    name: 'Name',
    invalidBirthDate: 'Invalid date of birth.',
    selectYourGender: 'Select your gender.',
    enterYourName: 'Enter your name.',
    islamicEducation: 'Islamic education for your children',
    italian: 'Italiano',
    english: 'English',
    arabic: 'العربية',
    selectLanguage: 'Select language',
    bacheca_title: 'Board',
    writeNote: 'Write a note...',
    noteDetail: 'Note detail',
    comments: 'Comments',
    writeComment: 'Write a comment...',
    noComments: 'No comments yet',
    deleteNote: 'Delete note',
    deleteNoteConfirm: 'Do you want to delete this note?',
    tags: 'Tags',
    todayEvents: "Today's events",
    noEventsToday: 'No events today',
    addWithPlus: 'Add with +',
    addEvent: 'Add event',
    eventName: 'Event name',
    eventNamePlaceholder: 'E.g. Arabic School',
    frequency: 'Frequency',
    daily: 'Daily',
    weekly: 'Weekly',
    monthly: 'Monthly',
    timePicker: 'Time',
    today: 'Today',
    salahToday: "Today's Salah",
    fajr: 'Fajr',
    dhuhr: 'Dhuhr',
    asr: 'Asr',
    maghrib: 'Maghrib',
    isha: 'Isha',
    fastingToday: 'Fasting today?',
    yes: 'Yes',
    no: 'No',
    partial: 'Partial',
    subjects: 'Education',
    arabo: 'Arabic',
    quran: "Qur'an",
    akhlaq: 'Akhlaq',
    aqidah: 'Aqidah',
    recentActivityLog: 'Recent activity',
    noActivity: 'No activity recorded',
    done: 'Done',
    notDone: 'Not done',
    noteOptional: 'Short note...',
    childOf: 'of',
    startTime: 'Start time',
    endTimePicker: 'End time',
    selectDay: 'Select day',
    selectDayOfMonth: 'Day of month',
    sun: 'Sun',
    mon: 'Mon',
    tue: 'Tue',
    wed: 'Wed',
    thu: 'Thu',
    fri: 'Fri',
    sat: 'Sat',
    quranMemorization: 'Quran Memorization',
    surahLearned: 'Learned',
    surahInProgress: 'In progress',
    surahNotStarted: 'To learn',
    surahCount: 'Surahs learned',
    quranToday: "Qur'an today?",
    salahTracker: 'Salah Tracker',
    fastingTracker: 'Fasting Tracker',
    enabled: 'Enabled',
    disabled: 'Disabled',
    deleteChild: 'Delete child',
    childSettings: 'Child settings',
  },
  ar: {
    home: 'الرئيسية',
    dashboard: 'لوحة التحكم',
    bacheca: 'اللوحة',
    settings: 'الإعدادات',
    hello: 'مرحبا',
    parent: 'ولي الأمر',
    yourChildren: 'أطفالك',
    limit: 'الحد',
    noChildrenTitle: 'لم تتم إضافة أطفال',
    noChildrenSub: 'اضغط على زر + لإضافة طفلك الأول',
    addChild: 'إضافة طفل',
    editChild: 'تعديل الطفل',
    childName: 'الاسم / اللقب *',
    childNamePlaceholder: 'اسم الطفل',
    birthDate: 'تاريخ الميلاد *',
    gender: 'الجنس *',
    male: 'ذكر',
    female: 'أنثى',
    coParent: 'ولي الأمر المشارك',
    connectCoParent: 'قم بربط ولي أمر مشارك أولاً في الإعدادات',
    cardColor: 'لون البطاقة',
    cancel: 'إلغاء',
    save: 'حفظ',
    delete: 'حذف',
    deleteConfirm: 'هل تريد حذف',
    limitReachedTitle: 'تم الوصول إلى الحد',
    limitReachedMsg: 'مع الخطة المجانية يمكنك إضافة طفل واحد فقط. قم بالترقية للحصول على عدد غير محدود!',
    enterName: 'أدخل اسم الطفل.',
    invalidDate: 'أدخل تاريخ ميلاد صالح.',
    selectGender: 'اختر جنس الطفل.',
    sonOf: 'ابنك وابن',
    daughterOf: 'ابنتك وابنة',
    years: 'سنوات',
    year: 'سنة',
    months: 'أشهر',
    photoOptional: 'صورة الملف الشخصي (اختياري)',
    progress: 'التقدم',
    recentActivity: 'النشاط الأخير',
    addChildFromHome: 'أضف طفلاً من الصفحة الرئيسية',
    toViewDashboard: 'لعرض لوحة التحكم',
    memorizedSurah: 'حفظ سورة الفاتحة',
    completedDua: 'أكمل درس الدعاء',
    practicedAdab: 'تدرب على آداب المائدة',
    example: 'مثال',
    coParents: 'أولياء الأمور المشاركون',
    yourInviteCode: 'رمز الدعوة الخاص بك',
    copied: 'تم النسخ!',
    inviteCodeCopied: 'تم نسخ رمز الدعوة',
    connectFirstCoParent: 'اربط ولي الأمر الأول',
    addAnotherCoParent: 'أضف ولي أمر آخر',
    codeMustBe6: 'يجب أن يكون الرمز 6 أحرف',
    connected: 'تم الربط!',
    coParentConnected: 'تم ربط ولي الأمر المشارك بنجاح!',
    code6chars: 'رمز من 6 أحرف',
    removeConnection: 'إزالة الاتصال',
    removeConnectionWith: 'إزالة الاتصال مع',
    remove: 'إزالة',
    dad: 'أب',
    mom: 'أم',
    coParentLabel: 'ولي أمر',
    pendingApprovals: 'الموافقات المعلقة',
    wantsToAdd: 'يريد إضافة',
    aChild: 'طفل',
    general: 'عام',
    account: 'الحساب',
    language: 'اللغة',
    plan: 'الخطة',
    premium: 'مميز',
    free: 'مجاني',
    info: 'معلومات',
    privacy: 'الخصوصية',
    privacyMsg: 'بياناتك متزامنة بشكل آمن.',
    version: 'الإصدار',
    logout: 'تسجيل الخروج',
    logoutConfirm: 'هل تريد تسجيل الخروج؟',
    upgradeTitle: 'ترقية إلى مميز',
    upgradeSub: 'أطفال غير محدودين + ميزات إضافية',
    editProfile: 'تعديل الملف الشخصي',
    changPhoto: 'تغيير الصورة',
    yourName: 'اسمك',
    name: 'الاسم',
    invalidBirthDate: 'تاريخ ميلاد غير صالح.',
    selectYourGender: 'اختر جنسك.',
    enterYourName: 'أدخل اسمك.',
    islamicEducation: 'التربية الإسلامية لأطفالك',
    italian: 'Italiano',
    english: 'English',
    arabic: 'العربية',
    selectLanguage: 'اختر اللغة',
    bacheca_title: 'اللوحة',
    writeNote: 'اكتب ملاحظة...',
    noteDetail: 'تفاصيل الملاحظة',
    comments: 'التعليقات',
    writeComment: 'اكتب تعليقاً...',
    noComments: 'لا توجد تعليقات بعد',
    deleteNote: 'حذف الملاحظة',
    deleteNoteConfirm: 'هل تريد حذف هذه الملاحظة؟',
    tags: 'العلامات',
    todayEvents: 'أحداث اليوم',
    noEventsToday: 'لا أحداث اليوم',
    addWithPlus: 'أضف بـ +',
    addEvent: 'إضافة حدث',
    eventName: 'اسم الحدث',
    eventNamePlaceholder: 'مثال: مدرسة عربية',
    frequency: 'التكرار',
    daily: 'يومي',
    weekly: 'أسبوعي',
    monthly: 'شهري',
    timePicker: 'الوقت',
    today: 'اليوم',
    salahToday: 'صلاة اليوم',
    fajr: 'الفجر',
    dhuhr: 'الظهر',
    asr: 'العصر',
    maghrib: 'المغرب',
    isha: 'العشاء',
    fastingToday: 'صيام اليوم؟',
    yes: 'نعم',
    no: 'لا',
    partial: 'جزئي',
    subjects: 'التعليم',
    arabo: 'العربية',
    quran: 'القرآن',
    akhlaq: 'الأخلاق',
    aqidah: 'العقيدة',
    recentActivityLog: 'النشاط الأخير',
    noActivity: 'لا يوجد نشاط مسجل',
    done: 'تم',
    notDone: 'لم يتم',
    noteOptional: 'ملاحظة قصيرة...',
    childOf: 'من',
    startTime: 'وقت البدء',
    endTimePicker: 'وقت الانتهاء',
    selectDay: 'اختر اليوم',
    selectDayOfMonth: 'يوم الشهر',
    sun: 'أحد',
    mon: 'إثن',
    tue: 'ثلا',
    wed: 'أرب',
    thu: 'خمي',
    fri: 'جمع',
    sat: 'سبت',
    quranMemorization: 'حفظ القرآن',
    surahLearned: 'محفوظة',
    surahInProgress: 'قيد الحفظ',
    surahNotStarted: 'للحفظ',
    surahCount: 'السور المحفوظة',
    quranToday: 'القرآن اليوم؟',
    salahTracker: 'متتبع الصلاة',
    fastingTracker: 'متتبع الصيام',
    enabled: 'مفعل',
    disabled: 'معطل',
    deleteChild: 'حذف الطفل',
    childSettings: 'إعدادات الطفل',
  },
};

interface I18nContextValue {
  lang: Language;
  setLang: (lang: Language) => void;
  t: (key: string) => string;
  isRTL: boolean;
}

const I18nContext = createContext<I18nContextValue | null>(null);

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLangState] = useState<Language>('it');

  const isRTL = lang === 'ar';

  const setLang = useCallback((newLang: Language) => {
    setLangState(newLang);
    if (Platform.OS !== 'web') {
      I18nManager.forceRTL(newLang === 'ar');
      I18nManager.allowRTL(newLang === 'ar');
    }
  }, []);

  const t = useCallback((key: string): string => {
    return translations[lang]?.[key] || translations.it[key] || key;
  }, [lang]);

  const value = useMemo(() => ({
    lang,
    setLang,
    t,
    isRTL,
  }), [lang, setLang, t, isRTL]);

  return (
    <I18nContext.Provider value={value}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within an I18nProvider');
  }
  return context;
}

export function getLanguageLabel(lang: Language): string {
  switch (lang) {
    case 'it': return 'Italiano';
    case 'en': return 'English';
    case 'ar': return 'العربية';
  }
}
